From ac60706ff2e9c4241f792b5f2fea6d1197b6dc70 Mon Sep 17 00:00:00 2001
From: Saul Paredes <saulparedes@microsoft.com>
Date: Fri, 11 Aug 2023 12:00:58 -0700
Subject: [PATCH] Avoid override target symlink by standard file in
 AbstractUnArchiver

---
 .../plexus/archiver/AbstractUnArchiver.java        | 14 ++++++++------
 1 file changed, 8 insertions(+), 6 deletions(-)

diff --git a/src/main/java/org/codehaus/plexus/archiver/AbstractUnArchiver.java b/src/main/java/org/codehaus/plexus/archiver/AbstractUnArchiver.java
index 41f6c8c..f40aab9 100644
--- a/src/main/java/org/codehaus/plexus/archiver/AbstractUnArchiver.java
+++ b/src/main/java/org/codehaus/plexus/archiver/AbstractUnArchiver.java
@@ -21,7 +21,6 @@
 import java.io.FileOutputStream;
 import java.io.IOException;
 import java.io.InputStream;
-import java.io.OutputStream;
 import java.util.ArrayList;
 import java.util.Date;
 import java.util.List;
@@ -32,8 +31,9 @@
 import org.codehaus.plexus.components.io.resources.PlexusIoResource;
 import org.codehaus.plexus.logging.AbstractLogEnabled;
 import org.codehaus.plexus.util.FileUtils;
-import org.codehaus.plexus.util.IOUtil;
 import org.codehaus.plexus.util.StringUtils;
+import static java.nio.file.StandardCopyOption.REPLACE_EXISTING;
+import java.nio.file.Files;
 
 // TODO there should really be constructors which take the source file.
 
@@ -336,6 +336,11 @@ protected void extractFile( final File srcF, final File dir, final InputStream c
         String canonicalDirPath = dir.getCanonicalPath();
         String canonicalDestPath = f.getCanonicalPath();
 
+        // don't allow override target symlink by standard file
+        if (StringUtils.isEmpty(symlinkDestination) && Files.isSymbolicLink(f.getCanonicalFile().toPath())) {
+            throw new ArchiverException("Entry is outside of the target directory (" + entryName + ")");
+        }
+
         if ( !canonicalDestPath.startsWith( canonicalDirPath ) )
         {
             throw new ArchiverException( "Entry is outside of the target directory (" + entryName + ")" );
@@ -365,10 +370,7 @@ else if ( isDirectory )
             }
             else
             {
-                try ( OutputStream out = new FileOutputStream( f ) )
-                {
-                    IOUtil.copy( compressedInputStream, out );
-                }
+                Files.copy(compressedInputStream, f.toPath(), REPLACE_EXISTING);
             }
 
             f.setLastModified( entryDate.getTime() );
-- 
2.25.1

